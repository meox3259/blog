---
title: "C++ - SFINAE"
draft: false
tags:
  - C++
---

## ğŸ” SFINAE åŸºæœ¬æ¦‚å¿µ

> **SFINAE**ï¼ˆ**S**ubsitution **F**ailure **I**s **N**ot **A**n **E**rrorï¼‰æ˜¯C++æ¨¡æ¿ç¼–ç¨‹ä¸­çš„é‡è¦åŸåˆ™ï¼ŒæŒ‡å½“æ¨¡æ¿å‚æ•°æ›¿æ¢å¤±è´¥æ—¶ï¼Œç¼–è¯‘å™¨ä¸ä¼šæŠ¥é”™ï¼Œè€Œæ˜¯ç»§ç»­æŸ¥æ‰¾å…¶ä»–å¯èƒ½åŒ¹é…çš„é‡è½½å‡½æ•°æˆ–æ¨¡æ¿ç‰¹åŒ–ã€‚

### ä¸»è¦ä½œç”¨

SFINAE åœ¨æ¨¡æ¿ç¼–ç¨‹ä¸­æœ‰ä¸‰ä¸ªå…³é”®ä½œç”¨ï¼š

1. **å®ç°å‡½æ•°é‡è½½çš„æ¡ä»¶é€‰æ‹©**
2. **å®ç°ç¼–è¯‘æœŸç±»å‹ç‰¹å¾æ£€æµ‹**
3. **å¯ç”¨/ç¦ç”¨ç‰¹å®šæ¨¡æ¿å®ä¾‹åŒ–**

---

## ğŸ’¡ ç†è§£ SFINAE çš„æ ¸å¿ƒï¼šFailure vs Error

ä»¥ä¸‹é€šè¿‡ä¸€ä¸ªç›´è§‚çš„ä¾‹å­æ¥ç†è§£ï¼š

```cpp
switch(token)
{
case IDENTIFIER:
    // do something
    break;
case LITERAL_NUMBER:
    // do something
    break;
case LITERAL_STRING:
    // do something
    break;
default:
    throw WrongToken(token);
}
```

- å½“ `token` æ˜¯ `LITERAL_NUMBER` æ—¶ï¼Œå°è¯•åŒ¹é… `IDENTIFIER` ä¼šå¤±è´¥ï¼ˆ**failure**ï¼‰
- å½“ `token` ä¸æ˜¯ä»»ä½•ä¸€ä¸ªé¢„å®šä¹‰å€¼æ—¶ï¼Œæ‰ä¼šè¿›å…¥ default åˆ†æ”¯ï¼ˆ**error**ï¼‰

**å…³é”®åŒºåˆ«**ï¼šfailure ä¸ç­‰åŒäº errorã€‚åªæœ‰å½“æ‰€æœ‰å¯èƒ½çš„åŒ¹é…éƒ½å¤±è´¥æ—¶ï¼Œæ‰è¢«è§†ä¸º errorã€‚

---

## ğŸ“Œ SFINAE çš„ä¸‰ä¸ªå…³é”®ç‚¹

1. **ä»€ä¹ˆæ—¶å€™å‡½æ•°æ¨¡æ¿å‘ç”Ÿ Substitution**
2. **ä»€ä¹ˆè¡Œä¸ºè¢«ç§°ä¸º Substitution**
3. **ä»€ä¹ˆè¡Œä¸ºä¸æ˜¯ Substitution failureï¼Œè€Œæ˜¯ Substitution error**

---

## âš ï¸ éè‰¯æ„ï¼ˆIll-formedï¼‰

åœ¨ C++ ä¸­ï¼Œ**éè‰¯æ„**æŒ‡**ä»£ç ä¸ç¬¦åˆ C++ æ ‡å‡†è¯­æ³•æˆ–è¯­ä¹‰è§„åˆ™çš„æƒ…å†µ**ã€‚

### å¸¸è§çš„éè‰¯æ„æƒ…å†µ

1. **è¯­æ³•é”™è¯¯**
   - ç¼ºå°‘åˆ†å·ã€æ‹¬å·ä¸åŒ¹é…ç­‰

2. **æ¨¡æ¿å…ƒç¼–ç¨‹ä¸­çš„æ›¿æ¢å¤±è´¥**
   - æ ¹æ® SFINAE åŸåˆ™ï¼Œç¼–è¯‘å™¨ä¼šè·³è¿‡è¯¥æ¨¡æ¿
   - ä½†è‹¥æ‰€æœ‰å€™é€‰æ¨¡æ¿å‡å¤±è´¥åˆ™æŠ¥é”™

3. **ä¸å½“ä½¿ç”¨ C++11 å¼•å…¥çš„ `[[attribute]]`**

   ```cpp
   void f() {
       switch(n) {
           case 1: [[fallthrough]];  // æ­£ç¡®ï¼šå…è®¸ç›´è½
           case 2: break;
           case 3: [[fallthrough]];  // éè‰¯æ„ï¼šä¸‹ä¸€è¯­å¥é case æ ‡å·
       }
   }
   ```

4. **å¼‚å¸¸è§„èŒƒå†²çª**

   ```cpp
   struct Base { virtual void f() noexcept; };
   struct Derived : Base { void f(); };  // é”™è¯¯ï¼šæ´¾ç”Ÿç±»å¼‚å¸¸è§„èŒƒæ¯”åŸºç±»å®½æ¾
   ```

5. **å€¼æˆ–ç±»å‹ä¸åŒ¹é…**

   ```cpp
   int a = "114514";  // é”™è¯¯ï¼šå­—ç¬¦ä¸²å­—é¢é‡ä¸èƒ½è½¬æ¢ä¸ºint
   ```

---

## ğŸ› ï¸ `std::enable_if` - SFINAE çš„å®ç”¨å·¥å…·

`std::enable_if` æ˜¯ä¸€ä¸ªåŸºäº SFINAE çš„æ¨¡æ¿å…ƒç¼–ç¨‹å·¥å…·ï¼Œç”¨äºåœ¨ç¼–è¯‘æ—¶æ ¹æ®æ¡ä»¶æ§åˆ¶æ¨¡æ¿çš„å®ä¾‹åŒ–ã€‚

### å·¥ä½œåŸç†

å¯¹äº `std::enable_if<bool B, class T = void>`ï¼š
- å¦‚æœ `B` ä¸º `true`ï¼Œåˆ™ `std::enable_if` æ‹¥æœ‰ç±»å‹ `T`
- è°ƒç”¨æ–¹æ³•ï¼š`using enable_if_t = typename enable_if<B,T>::type`

### å®é™…åº”ç”¨ç¤ºä¾‹

ä»¥ä¸‹æ˜¯è§£å†³å‡½æ•°é‡è½½å†²çªçš„å®é™…ä¾‹å­ï¼š

```cpp
struct ICounter {
  virtual void increase() = 0;
  virtual ~ICounter() {}
};

struct Counter: public ICounter {
   void increase() override {
      // Implements
   }
};

// æ— æ³•ç¼–è¯‘çš„ç‰ˆæœ¬ - å‡½æ•°ç­¾åå†²çª
template <typename T>
void inc_counter(T& counterObj) {
  counterObj.increase();
}

template <typename T>
void inc_counter(T& intTypeCounter){
  ++intTypeCounter;
}
```

**ä½¿ç”¨ `std::enable_if` è§£å†³å†²çª**ï¼š

```cpp
// åªåŒ¹é… ICounter çš„æ´¾ç”Ÿç±»
template <typename T> 
void inc_counter(
  T& counterObj, 
  typename std::enable_if<
    std::is_base_of<ICounter, T>::value
  >::type* = nullptr
);

// åªåŒ¹é…æ•´æ•°ç±»å‹
template <typename T> 
void inc_counter(
  T& counterInt,
  typename std::enable_if<
    std::is_integral<T>::value
  >::type* = nullptr
);
```

è¿™é‡Œä½¿ç”¨äº†ä¸¤ä¸ªç±»å‹ç‰¹å¾ï¼š
- `std::is_base_of<ICounter, T>::value` - æ£€æŸ¥ `T` æ˜¯å¦æ˜¯ `ICounter` çš„å­ç±»
- `std::is_integral<T>::value` - æ£€æŸ¥ `T` æ˜¯å¦æ˜¯æ•´å‹

**å·¥ä½œåŸç†**ï¼šé€šè¿‡ `std::enable_if` æ¡ä»¶æ€§å¯ç”¨æ¨¡æ¿ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œæ ¹æ® SFINAE è§„åˆ™ï¼Œè¯¥é‡è½½ç‰ˆæœ¬ä¼šè¢«æ’é™¤åœ¨å€™é€‰é›†ä¹‹å¤–ã€‚

---

## å‚è€ƒèµ„æ–™

- [C++æ¨¡æ¿è¿›é˜¶æŒ‡å—ï¼šSFINAE](https://zhuanlan.zhihu.com/p/21314708)